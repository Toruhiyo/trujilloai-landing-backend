files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/10_capture_websocket_errors.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Create a Python script to test the WebSocket and capture the full error
      cat > /tmp/test_websocket.py<< 'EOF'
      import asyncio
      import websockets
      import json
      import sys
      
      async def test_websocket():
          uri = "ws://localhost:8000/voicechat/ws"
          try:
              async with websockets.connect(uri) as websocket:
                  print("Connected to WebSocket successfully!")
                  # Wait for messages
                  while True:
                      msg = await websocket.recv()
                      print(f"< {msg}")
          except Exception as e:
              print(f"ERROR: {e}")
              print(f"ERROR TYPE: {type(e)}")
              if hasattr(e, 'status_code'):
                  print(f"Status code: {e.status_code}")
              if hasattr(e, 'headers'):
                  print(f"Headers: {e.headers}")
              if hasattr(e, 'response'):
                  print(f"Response: {e.response}")
                  try:
                      print(f"Response body: {await e.response.text()}")
                  except:
                      pass
      
      # Run the test
      asyncio.run(test_websocket())
      EOF
      
      # Install websockets package if needed
      pip install websockets
      
      # Run the test script and log the output
      echo "===== WebSocket Error Capture ====="> /var/log/websocket_error_details.log
      python /tmp/test_websocket.py >> /var/log/websocket_error_details.log 2>&1
      
      # Make the log accessible via eb logs
      ln -sf /var/log/websocket_error_details.log /opt/elasticbeanstalk/tasks/taillogs.d/websocket_error_details.log
      
      echo "WebSocket error capture completed"

container_commands:
  01_capture_errors:
    command: "sudo /opt/elasticbeanstalk/hooks/appdeploy/post/10_capture_websocket_errors.sh" 
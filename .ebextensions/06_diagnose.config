files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_diagnose_websocket.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      
      # Output diagnostic information
      echo "==== WebSocket Diagnostic Information ===="> /var/log/websocket_diagnostics.log
      
      # Check if FastAPI is accessible
      echo "Checking FastAPI health endpoint:">> /var/log/websocket_diagnostics.log
      curl -v http://localhost:8000/health 2>&1 >> /var/log/websocket_diagnostics.log
      
      # Check WebSocket endpoints
      echo -e "\nChecking WebSocket endpoint direct access:">> /var/log/websocket_diagnostics.log
      curl -v -H "Connection: Upgrade" -H "Upgrade: websocket" -H "Sec-WebSocket-Key: SGVsbG8sIHdvcmxkIQ==" -H "Sec-WebSocket-Version: 13" http://localhost:8000/voicechat/ws 2>&1 >> /var/log/websocket_diagnostics.log
      
      # Check proxy headers
      echo -e "\nChecking Nginx proxy configuration:">> /var/log/websocket_diagnostics.log
      cat /etc/nginx/conf.d/websocket.conf >> /var/log/websocket_diagnostics.log 2>&1
      cat /etc/nginx/conf.d/proxy.conf >> /var/log/websocket_diagnostics.log 2>&1
      
      # Check if the proper handlers are in place in FastAPI
      echo -e "\nChecking for running processes:">> /var/log/websocket_diagnostics.log
      ps aux | grep uvicorn >> /var/log/websocket_diagnostics.log
      
      # Make the log accessible via eb logs
      ln -sf /var/log/websocket_diagnostics.log /opt/elasticbeanstalk/tasks/taillogs.d/websocket_diagnostics.log
      
      echo "Diagnostic script completed"
      
container_commands:
  01_run_diagnostics:
    command: "sudo /opt/elasticbeanstalk/hooks/appdeploy/post/99_diagnose_websocket.sh" 